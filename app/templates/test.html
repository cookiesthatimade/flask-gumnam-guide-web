<!-- /*
* Template Name: Property
* Template Author: Untree.co
* Template URI: https://untree.co/
* License: https://creativecommons.org/licenses/by/3.0/
*/ -->
<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Untree.co">
    <meta name="description" content="" />
    <meta name="keywords" content="bootstrap, bootstrap5" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css">

</head>


<body>
    <input type="file" id="wearableData" name="wearableData" accept="audio/*">
    <button type="button" class="btn-secondary" id="startRecordingButton" style="float: left;">녹음 시작</button>
    <input type="submit" class="btn btn-primary" value="Submit">
    <!-- 3번 버튼 추가 -->
    <button type="button" class="btn btn-info" id="button3">3번 버튼</button>

    <script src="https://cdn.jsdelivr.net/npm/mic-recorder-to-mp3/dist/index.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script>
        const recordButton = document.getElementById('startRecordingButton');
        let isRecording = false;
        let recorder;

        recordButton.addEventListener('click', () => {
            if (!isRecording) {
                startRecording();
            } else {
                stopRecording();
            }
        });

        function startRecording() {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    recorder = new MicRecorder({ bitRate: 128 });
                    recorder.start().catch(err => console.error(err));
                    isRecording = true;
                    recordButton.textContent = '녹음 중지';
                })
                .catch(err => console.error(err));
        }

        function stopRecording() {
            recorder.stop()
                .getMp3().then(([buffer, blob]) => {
                    const file = new File(buffer, 'recorded_audio.wav', { type: blob.type });
                    recorder = null;
                    isRecording = false;
                    console.log(isRecording);
                    recordButton.textContent = '녹음 시작';

                    // 클로바 API 호출
                    checkClovaAPI(file);
                })
                .catch(err => console.error(err));
        }

        function checkClovaAPI(audioFile) {
            const clientId = 'qo066si4iu'; // 클로바 API 클라이언트 아이디
            const clientSecret = '1VSc44NwMpKQoIxiGAMxmURnnhegSDFeGHYQdLg3'; // 클로바 API 클라이언트 시크릿

            // 클로바 API 호출
            fetch('https://naveropenapi.apigw.ntruss.com/recog/v1/stt?lang=ko-KR', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/octet-stream',
                    'X-NCP-APIGW-API-KEY-ID': clientId,
                    'X-NCP-APIGW-API-KEY': clientSecret,
                },
                body: audioFile,
            })
                .then(response => response.json())
                .then(data => {
                    const clovaResponseText = data.text;

                    // 특정 단어 감지
                    if (clovaResponseText.includes("3번") || clovaResponseText.includes("3번출구")) {
                        // 특정 단어가 포함되어 있으면 3번 버튼 클릭
                        clickButton3();
                    }
                })
                .catch(err => {
                    console.error('네이버 클로바 API 호출 실패:', err);
                });
        }

        // 3번 버튼을 클릭하는 함수
        function clickButton3() {
            const button3 = document.getElementById('button3');
            if (button3) {
                button3.click();
            } else {
                console.log('3번 버튼을 찾을 수 없습니다.');
            }
        }
    </script>
</body>
</html>